<!DOCTYPE html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="rgb(46, 44, 79)">
  <meta name="description" content="使用 Javascript 来操作 Github Action">
  <meta name="keywords" content="Git, GitHub">
  <title>
    GitHub Action MetaData
  </title>
  <link rel="stylesheet" href="/public/css/index.css">
  <link rel="stylesheet" href="/public/css/markdown.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="/public/JavaScript/index.js"></script>
</head><header class="blog-header">
  <a href="https://github.com/fwqaaq" target="_blank">
    <img src="https://avatars.githubusercontent.com/u/82551626?v=4" loading="lazy" alt="me" srcset="">
  </a>
  <nav class="header-nav">
    <a class="decoration-line" href="/"><i class="fa-solid fa-house-chimney fa-xs"></i>
      <span class="disappear">Home</span>
    </a>
    <a class="decoration-line" href="/./about/index.html"><i class="fa-solid fa-address-card fa-xs"></i>
      <span class="disappear">About</span></a>
    <a class="decoration-line" href="/./archive/index.html"><i class="fa-solid fa-box-archive fa-xs"></i> <span
        class="disappear">Archive</span></a>
    <a class="decoration-line" href="/./tags/index.html"><i class="fa-solid fa-tag fa-xs"></i> <span
        class="disappear">Tag</span></a>
    <div class="toy"><i class="fa-solid fa-gamepad fa-xs"></i> <span class="disappear">Toy</span>
      <nav class="toy-nav disappear">
        <a class="decoration-line" href="/public/resume/">我的简历</a>
        <a class="decoration-line" href="/public/write-css/index.html">学习 UI</a>
      </nav>
    </div>
    <a class="decoration-line" href="/feed.xml"><i class="fa-solid fa-rss fa-xs"></i> <span
        class="disappear">RSS</span></a>
    <a class="decoration-line model" href="#" class="model"><i class="fa-solid fa-sun fa-xs"></i></a>
  </nav>
</header><main class="blog-main">
          <article class="blog-article">
            <h1>GitHub Action MetaData</h1>
            <hr>
            <blockquote>
<p>创建 action 和使用 workflows 是两个不同的操作</p>
</blockquote>
<ol>
<li>使用 <a href="https://docs.github.com/cn/actions/using-workflows/about-workflows">workflows</a> 是一个自动化的过程
<ul>
<li>由 <code>.github/workflows</code> 下的 <code>yaml</code> 文件定义，可以是事件，事件或者手动触发</li>
</ul>
</li>
<li>创建 <a href="https://docs.github.com/cn/actions/creating-actions/about-custom-actions">action</a> 可以创建自己的操作或者使用和自定义 github 社区分享的操作
<ul>
<li>在操作主要元数据文件按来定义操作的输入，输出和主要进入点。元数据的文件名必须要 <code>action.yml</code></li>
</ul>
</li>
</ol>
<h2 id="javascript-操作"><a href="https://docs.github.com/cn/actions/creating-actions/creating-a-javascript-action">JavaScript 操作</a><a class="anchor" aria-label="Anchor" aria-hidden="true" data-anchorjs-icon="🔗" href="#javascript-操作"></a></h2>
<ul>
<li>这里尝试演示一个使用 actions 元数据去编写一个 Issue 自动提交</li>
</ul>
<blockquote>
<p><a href="https://docs.github.com/cn/actions/creating-actions/metadata-syntax-for-github-actions">GitHub Actions 的元数据语法</a></p>
</blockquote>
<ul>
<li>在根目录下创建一个 <code>action.yml</code> 文件，并且文件名称只能是这个</li>
</ul>
<pre><code class="hl language-yaml"><span class="hl-attr">name:</span> <span class="hl-string">'test one create issues'</span>
<span class="hl-attr">description:</span> <span class="hl-string">'test create issues'</span>
<span class="hl-attr">inputs:</span>
  <span class="hl-attr">token:</span>
    <span class="hl-attr">description:</span> <span class="hl-string">'ACTION_ACCESS'</span>
    <span class="hl-attr">required:</span> <span class="hl-literal">true</span>
    <span class="hl-attr">default:</span> <span class="hl-string">${{github.token}}</span>
  <span class="hl-attr">repoURL:</span>
    <span class="hl-attr">description:</span> <span class="hl-string">'repo'</span>
    <span class="hl-attr">default:</span> <span class="hl-string">${{github.repositoryUrl}}</span>
  <span class="hl-attr">path:</span>
    <span class="hl-attr">description:</span> <span class="hl-string">'path'</span>
    <span class="hl-attr">default:</span> <span class="hl-string">${{github.action_path}}</span>
<span class="hl-attr">runs:</span>
  <span class="hl-attr">using:</span> <span class="hl-string">'node16'</span>
  <span class="hl-attr">main:</span> <span class="hl-string">'index.mjs'</span>
</code></pre>
<ul>
<li><code>inputs</code> 是指定从工作流（workflows）中获取对应的输入字段，<code>token</code> 是工作流（workflows）中的名称</li>
<li><code>runs</code>：指定的操作，这里必须指定是 JavaScript 操作，复合操作还是 Docker 容器操作以及操作的执行方式
<ul>
<li>
<p><code>using</code>：<strong>必要</strong>。指定 <code>main</code> 中代码的执行环境</p>
</li>
<li>
<p><code>main</code>：<strong>必要</strong>。包含操作的文件</p>
</li>
<li>
<p><code>pre</code>：允许你在 <code>main</code> 操作开始之前，在作业开始时运行脚本</p>
</li>
<li>
<p><code>pre-if</code>：允许定义 <code>pre</code> 操作执行的条件。pre 操作只会在满足 <code>pre-if</code> 中的条件运行。如果未设置，则 <code>pre-if</code> 默认使用 <code>always()</code></p>
<pre><code class="hl language-yml"><span class="hl-attr">pre:</span> <span class="hl-string">'cleanup.js'</span>
<span class="hl-attr">pre-if:</span> <span class="hl-string">runner.os</span> <span class="hl-string">==</span> <span class="hl-string">'linux'</span>
</code></pre>
</li>
<li>
<p><code>post</code>：允许你在 <code>main</code> 操作完成后，在作业结束时运行脚本</p>
<ul>
<li>例如，你可以使用 <code>post</code> 终止某些进程或删除不需要的文件</li>
</ul>
</li>
<li>
<p><code>post-if</code>：允许定义的 <code>post</code> 操作执行的条件，和 <code>pre-if</code> 类似</p>
<pre><code class="hl language-yml"><span class="hl-attr">runs:</span>
  <span class="hl-attr">using:</span> <span class="hl-string">'node16'</span>
  <span class="hl-attr">main:</span> <span class="hl-string">'index.js'</span>
  <span class="hl-attr">post:</span> <span class="hl-string">'cleanup.js'</span>
  <span class="hl-attr">post:</span> <span class="hl-string">'cleanup.js'</span>
  <span class="hl-attr">post-if:</span> <span class="hl-string">runner.os</span> <span class="hl-string">==</span> <span class="hl-string">'linux'</span>
</code></pre>
</li>
<li>
<p><code>steps</code>：操作中的步骤。这里是符合操作，using 必须指定--><code>using:"composite"</code></p>
<ul>
<li><code>shell</code>：如果有 run 操作，必须指定 <code>shell</code></li>
</ul>
<pre><code class="hl language-js"><span class="hl-attr">runs</span>:
  <span class="hl-attr">using</span>: <span class="hl-string">"composite"</span>
  <span class="hl-attr">steps</span>:
    - <span class="hl-attr">run</span>: ${{ github.<span class="hl-property">action_path</span> }}/test/script.<span class="hl-property">sh</span>
      <span class="hl-attr">shell</span>: bash
</code></pre>
<p>...</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>编写 index.js 文件</p>
</blockquote>
<ul>
<li>
<p>下载 octokit:<code>pnpm add octokit</code>，这里需要使用这个包对 github 暴露的接口进行操作</p>
</li>
<li>
<p>下载 <code>@actions/core</code>:<code>pnpm add @actions/core</code>，该包提供一个接口，用于工作流程命令，输入和输出变量，退出状态以及调试</p>
<pre><code class="hl language-js"><span class="hl-keyword">import</span> { <span class="hl-title class_">Octokit</span> } <span class="hl-keyword">from</span> <span class="hl-string">"octokit"</span>;
<span class="hl-keyword">import</span> { getInput } <span class="hl-keyword">from</span> <span class="hl-string">"@actions/core"</span>;
<span class="hl-keyword">import</span> dayjs <span class="hl-keyword">from</span> <span class="hl-string">"dayjs"</span>;
<span class="hl-keyword">const</span> token = <span class="hl-title function_">getInput</span>(<span class="hl-string">"token"</span>);
<span class="hl-keyword">const</span> octokit = <span class="hl-keyword">new</span> <span class="hl-title class_">Octokit</span>({
  <span class="hl-attr">auth</span>: token,
});
<span class="hl-keyword">await</span> octokit.<span class="hl-property">rest</span>.<span class="hl-property">issues</span>.<span class="hl-title function_">create</span>({
  <span class="hl-attr">owner</span>: <span class="hl-string">"fwqaaq"</span>,
  <span class="hl-attr">repo</span>: <span class="hl-string">"demo"</span>,
  <span class="hl-attr">title</span>: <span class="hl-title function_">getTitle</span>(),
  <span class="hl-attr">body</span>: <span class="hl-title function_">getBody</span>(),
});

<span class="hl-keyword">function</span> <span class="hl-title function_">getTitle</span>(<span class="hl-params"></span>) {
  <span class="hl-keyword">return</span> <span class="hl-title function_">dayjs</span>().<span class="hl-title function_">format</span>(<span class="hl-string">"YYYY-MM-DD"</span>);
}

<span class="hl-keyword">function</span> <span class="hl-title function_">getBody</span>(<span class="hl-params"></span>) {
  <span class="hl-keyword">return</span> <span class="hl-string">"* test a new task"</span>;
}
</code></pre>
</li>
<li>
<p>这里的 <code>auth:token</code>，是获取的 <code>workflows</code> 中 <code>with</code> 关键字设置的输入参数</p>
</li>
</ul>
<blockquote>
<p>编写工作流 <code>workflows</code></p>
</blockquote>
<pre><code class="hl language-js"><span class="hl-attr">on</span>: [push]

<span class="hl-attr">jobs</span>:
  <span class="hl-attr">test_one_issues</span>:
    runs-<span class="hl-attr">on</span>: ubuntu-latest
    <span class="hl-attr">name</span>: create issues action
    <span class="hl-attr">steps</span>:
      - <span class="hl-attr">name</span>: <span class="hl-title class_">Checkout</span>
        <span class="hl-attr">uses</span>: actions/checkout@v3
      - <span class="hl-attr">name</span>: node
        <span class="hl-attr">uses</span>: actions/setup-node@v3<span class="hl-number">.0</span><span class="hl-number">.0</span>
        <span class="hl-attr">with</span>:
          node-<span class="hl-attr">version</span>: <span class="hl-string">"16.x"</span>
      - <span class="hl-attr">name</span>: install
        <span class="hl-attr">run</span>: npm install
      - <span class="hl-attr">name</span>: create issues
        <span class="hl-attr">uses</span>: ./
        <span class="hl-attr">with</span>:
          <span class="hl-attr">token</span>: ${{secrets.<span class="hl-property">ACTION_ACCESS</span>}}
</code></pre>
<ul>
<li>最后一个 <code>create issues</code> 中的 <code>uses:./</code> 就是指定根路径下自己的 action 元数据 <code>action.yml</code></li>
<li><code>with</code> 就是传给 <code>action.yml</code> 的键值对。并且在 <code>index.js</code> 中使用了 <code>@action/core</code> 中的 <code>getInput</code> 获取</li>
</ul>
<blockquote>
<p>如果只想打包 dist 文件到仓库，可以使用 <code>@vercel/ncc</code> 这个包，这个包只会把引用的模块加载到 dist 包中</p>
</blockquote>
<ul>
<li>下载 ncc 包：<code>pnpm add @vercel/ncc</code></li>
<li>然后添加脚本：<code>"build": "ncc build index.mjs --license licenses.txt"</code></li>
<li>运行之后就可以使用 dist 包每天更新 issue</li>
</ul>
        </article></main><script src="https://giscus.app/client.js"
        data-repo="fwqaaq/fwqaaq.github.io"
        data-repo-id="R_kgDOHCFK2A"
        data-category="Show and tell"
        data-category-id="DIC_kwDOHCFK2M4CYOLh"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async></script>